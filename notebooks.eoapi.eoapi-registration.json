{"version":3,"kind":"Notebook","sha256":"99f0577bda628d38a2499508d4f3de017dc45927f0918f4304c5ad7b76f4ddd2","slug":"notebooks.eoapi.eoapi-registration","location":"/notebooks/eoAPI/eoAPI_registration.ipynb","dependencies":[],"frontmatter":{"title":"eoAPI registration example","content_includes_title":false,"kernelspec":{"name":"conda-env-global-global-eoxhub_general-py","display_name":"global-global-eoxhub_general","language":"python"},"github":"https://github.com/eoxhub-workspaces/eoxhub-notebooks","subject":"Notebook examples","numbering":{"title":{"offset":2}},"source_url":"https://github.com/eoxhub-workspaces/eoxhub-notebooks/blob/main/notebooks/eoAPI/eoAPI_registration.ipynb","edit_url":"https://github.com/eoxhub-workspaces/eoxhub-notebooks/edit/main/notebooks/eoAPI/eoAPI_registration.ipynb","exports":[{"format":"ipynb","filename":"eoAPI_registration.ipynb","url":"/eoxhub-notebooks/build/eoAPI_registration-9133f022e51d2bca477add0872f114d6.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"This notebook demonstrates how to register data on the workspace eoAPI instance. The main step is creation of STAC metadata information to pass it to the eoAPI STAC endpoint.\nIn order to show the full flow this notebooks also fetches some sample data and does following steps:","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"V68GptI6Q7"}],"key":"t6rdlKYaRl"},{"type":"list","ordered":true,"start":1,"spread":false,"position":{"start":{"line":4,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Download","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"oHtuU3cEuB"}],"key":"TQm3Spz5tP"},{"type":"text","value":": Download file to mounted bucket path.","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"pamvovl4TP"}],"key":"GzGrnYqjh1"}],"key":"h8cDxKWvSx"},{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Collection creation","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"bE5l756SXG"}],"key":"RNqL9CrZC1"},{"type":"text","value":": Create the STAC collection the file will be registered to.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"bYewooRJJc"}],"key":"AOl951eFoW"}],"key":"HKzyHnydQ5"},{"type":"listItem","spread":true,"position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"Metadata extraction","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"qb27g49NB0"}],"key":"CivQTzfkxa"},{"type":"text","value":": Extract as much information as possible from source file to create STAC item.","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"Ri5240M4KE"}],"key":"PPDl6oW7EC"}],"key":"alTYASGhfC"},{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"Ingest","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"FjS2ikyL9d"}],"key":"fDF2G2c9lF"},{"type":"text","value":": Post the resulting STAC ttem to the eoAPI STAC endpoint.","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"mGZX4A23xS"}],"key":"hwhPzaBdWz"}],"key":"hYykg5WGzO"}],"key":"NK6HBQgzqD"}],"key":"o0pN6ed2sf"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Environment Checks","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"DlfpfPT4xc"}],"identifier":"environment-checks","label":"Environment Checks","html_id":"environment-checks","implicit":true,"key":"LO5XiMhmk6"}],"key":"bxxRlTthub"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# First some checks to see the environment is as expected\nimport sys\nimport os\nimport importlib.util\n\n# List the packages to check\nrequired = [\"pystac\", \"rio_stac\", \"pystac_client\", \"requests\", \"rasterio\"]\nmissing = [p for p in required if importlib.util.find_spec(p.replace('-','_')) is None]\n\nif missing:\n    print(f\" ERROR: Missing packages: {', '.join(missing)}\")\n    print(\"It looks like the wrong Conda kernel is active. Please switch kernels and try again.\")\n    sys.exit(\"Execution stopped: Missing dependencies.\")\n\n# If check passes, proceed with imports\nfrom datetime import datetime, timezone\nfrom pystac import Collection, Extent, SpatialExtent, TemporalExtent, Link\nfrom rio_stac import create_stac_item\nimport rasterio\nimport requests\n\nprint(\"Environment ready.\")","key":"CvIWZ9ulU3"},{"type":"outputs","id":"yi4zp5hImlSoA0eQY-DCC","children":[],"key":"ifhmqysen1"}],"key":"Yu4hi1r7zp"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Configuration","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"m2crr5ZNIg"}],"identifier":"configuration","label":"Configuration","html_id":"configuration","implicit":true,"key":"B4cMcmHz8s"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"If using your own file adjust ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"J9IELmz1xv"},{"type":"inlineCode","value":"FILE_PATH","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"XIZsGTJaH4"},{"type":"text","value":" to match its location and remove the download step.","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"KJBDyjFoLa"}],"key":"PFr5JA1ql3"}],"key":"IaLTJQQQff"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"STAC_API_URL = \"http://eoapi-rw-stac:8080\" \nCOLLECTION_ID = \"demo-collection\"\nCOG_SOURCE_URL = \"https://sentinel-cogs.s3.us-west-2.amazonaws.com/sentinel-s2-l2a-cogs/36/Q/WD/2020/7/S2A_36QWD_20200701_0_L2A/TCI.tif\"\nFILE_PATH = \"./bucket/demo_data/TCI.tif\"\n\nos.makedirs(os.path.dirname(FILE_PATH), exist_ok=True)","key":"tPUEe2CeHL"},{"type":"outputs","id":"b1WRrVXlV9xfZV-3gGgwz","children":[],"key":"FpXYUiJdkt"}],"key":"GoE9lPPB8f"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"1. Download","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"i1qgQvyRRG"}],"identifier":"id-1-download","label":"1. Download","html_id":"id-1-download","implicit":true,"key":"LeOC92MTNc"}],"key":"wHir5tCYza"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# First we download the example file and put it into the mounted bucket\n# You can also use the File Browser to upload your data\n# (should be used for files smaller then 1 GB)\nif os.path.exists(FILE_PATH):\n    print(f\"File exists at {FILE_PATH}. Skipping.\")\nelse:\n    print(f\"Downloading to {FILE_PATH}...\")\n    with requests.get(COG_SOURCE_URL, stream=True) as r:\n        r.raise_for_status()\n        with open(FILE_PATH, 'wb') as f:\n            for chunk in r.iter_content(chunk_size=8192):\n                f.write(chunk)","key":"HfzP1515Eh"},{"type":"outputs","id":"FbvDw5gFsaEC1n13dZk6E","children":[],"key":"Ha33Uvxsa5"}],"key":"PsQB9SXQOk"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"2. Collection creation","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"npMGOzFdEV"}],"identifier":"id-2-collection-creation","label":"2. Collection creation","html_id":"id-2-collection-creation","implicit":true,"key":"zwPOIdPIDQ"}],"key":"N3SlzcjGro"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Then we create the collection (only if it does not already exist)\ncheck_url = f\"{STAC_API_URL}/collections/{COLLECTION_ID}\"\nresp = requests.get(check_url)\nif resp.status_code == 200:\n    print(f\"Collection '{COLLECTION_ID}' exists.\")\nelse:\n    print(f\"Creating collection '{COLLECTION_ID}'...\")\n    coll = Collection(\n        id=COLLECTION_ID,\n        title=\"Demo collection\",\n        description=\"Demo COG collection\",\n        extent=Extent(SpatialExtent([[-180, -90, 180, 90]]), TemporalExtent([[datetime(2020,1,1,tzinfo=timezone.utc), None]])),\n        license=\"CC-BY-4.0\"\n    )\n    # Sending a POST request with the Collection json to create the collection\n    requests.post(f\"{STAC_API_URL}/collections\", json=coll.to_dict()).raise_for_status()","key":"pq7ow6AP0l"},{"type":"outputs","id":"56p0bXzWI11yEtt7tJjj7","children":[],"key":"izNRI00Fu7"}],"key":"CP5GDlXUOF"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# If we wanted to delete the collection we could use following command\n# requests.delete(f\"{STAC_API_URL}/collections/{COLLECTION_ID}\")","key":"Bob1Yu8PZ2"},{"type":"outputs","id":"POg3T5v58Zk-o4CdL4GDu","children":[],"key":"NeBvY26MUI"}],"key":"MH8bsSX2LR"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"3. Metadata Extraction","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"GAVRtMqJjN"}],"identifier":"id-3-metadata-extraction","label":"3. Metadata Extraction","html_id":"id-3-metadata-extraction","implicit":true,"key":"r3j4GdFMiY"}],"key":"CEHzDXrU5N"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# We need a STAC item definition in order to register it into the collection\n# see https://github.com/radiantearth/stac-spec/blob/master/item-spec/item-spec.md for further details\n\n# rio-stac provides a useful helper tool create_stac_item\n# to extract metadata from the raster file and create a STAC item from it\n\n# We need to define the connected bucket to this workspace\nBUCKET = os.getenv(\"WORKSPACE_BUCKET\")\nROOT_FILE_PATH = FILE_PATH.replace(\"./bucket\", \"\")\n# cloud location eoAPI TiTiler will access the data assets from\nS3_URI = f\"s3://{BUCKET}{ROOT_FILE_PATH}\"\n\nitem = create_stac_item(\n    source=FILE_PATH,\n    asset_href=S3_URI,\n    id=os.path.basename(ROOT_FILE_PATH).split('.')[0],\n    collection=COLLECTION_ID,\n    asset_name=\"data\"\n)\n\n# Add preview link to allow rendering data in eoAPI GUI\neoapi_endpoint = os.getenv(\"RASTER_ENDPOINT\")\nxyz = f\"{eoapi_endpoint}/collections/{COLLECTION_ID}/items/{item.id}/tiles/WebMercatorQuad/{{z}}/{{x}}/{{y}}?assets=data\"\nitem.add_link(Link(rel=\"xyz\", target=xyz, media_type=\"application/json\"))\n","key":"xjTbetjC6c"},{"type":"outputs","id":"0R0hwwlkhDMjFusUWvELs","children":[],"key":"hxDa6GQmRb"}],"key":"qUNUMge6J6"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# We can print the item by uncommenting if we want to have a look\n# item.to_dict()","key":"SPKnBLK3JG"},{"type":"outputs","id":"SghbQg6mE9nzqmnA4QrA9","children":[],"key":"ohW6FEuHmG"}],"key":"Pr0LeBZi7P"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"4. Ingestion","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ualRNdEEU2"}],"identifier":"id-4-ingestion","label":"4. Ingestion","html_id":"id-4-ingestion","implicit":true,"key":"DpBSwKjHv0"}],"key":"cBLbeem10v"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Now that the item was created we can pass it to eoAPI for ingestion\n\nurl = f\"{STAC_API_URL}/collections/{COLLECTION_ID}/items\"\nresponse = requests.post(url, json=item.to_dict())\n\nif response.status_code in [200, 201]:\n    print(\"Successfully posted STAC Item.\")\nelse:\n    print(f\"Error {response.status_code}: {response.text}\")","key":"yoVkHVmkTM"},{"type":"outputs","id":"lf2QMBripj8n6ItPhsdC1","children":[],"key":"tTmViQyzGQ"}],"key":"vJ3w1arTyQ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Update temporal and spatial extent based on ingested datasets\nimport requests\n\ndef update_stac(url, cid):\n    # 1. Fetch all items (limited to 1000 for brevity)\n    items = requests.get(f\"{url}/collections/{cid}/items?limit=1000\").json()['features']\n    \n    # 2. Extract and calculate (flatten coordinates and collect dates)\n    coords = [pt for f in items for pt in f['geometry']['coordinates'][0]]\n    dts = [f['properties']['datetime'] for f in items]\n    \n    # 3. Patch the collection\n    ext = {\n        \"spatial\": {\"bbox\": [[min(c[0] for c in coords), min(c[1] for c in coords), \n                             max(c[0] for c in coords), max(c[1] for c in coords)]]},\n        \"temporal\": {\"interval\": [[min(dts), max(dts)]]}\n    }\n    \n    r = requests.patch(f\"{url}/collections/{cid}\", json={\"extent\": ext})\n    print(\"Updated\" if r.ok else f\"Error: {r.text}\")\n\nupdate_stac(STAC_API_URL, COLLECTION_ID)","key":"eY88ZuPgMG"},{"type":"outputs","id":"SjjvPfgKZfrrbJNM2CC0P","children":[],"key":"a7IlKFjXye"}],"key":"UtF1vRr3RX"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from IPython.display import Image, display\n\nurl = f\"{eoapi_endpoint}/collections/demo-collection/items/TCI/preview?assets=data\"\ndisplay(Image(url=url, width=500))","key":"tLqRLiFYa8"},{"type":"outputs","id":"aSqYfMQUM3C-9yYmtKUSO","children":[],"key":"PYlUeznzcl"}],"key":"VTq8WqPPm8"}],"key":"Jxdq6X2K5p"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"CDSE Tiled Data Access","url":"/notebooks/data-access/cdse-tiled-data-access","group":"Data Access"},"next":{"title":"Scale your processes with Dask - hands on example","url":"/notebooks/pangeo-dask-notebooks/example-wildfires","group":"Pangeo Dask Notebooks"}}},"domain":"http://localhost:3000"}